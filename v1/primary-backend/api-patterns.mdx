---
title: "API Patterns"
description: "Common patterns and conventions used in the Primary Backend API"
---

## Overview

The Primary Backend follows consistent patterns and conventions across all endpoints. Understanding these patterns will help you integrate with the API more effectively.

## URL Structure

### Base URL Pattern
```
http://localhost:3001/api/v1/{resource}
```

### Nested Resources
```
/api/v1/sectors/{sectorId}/buildings
/api/v1/buildings/{buildingId}/floors
/api/v1/floors/{floorId}/units
```

## HTTP Methods

### Standard CRUD Operations

| Method | Purpose | Example |
|--------|---------|---------|
| `GET` | Retrieve resource(s) | `GET /users` |
| `POST` | Create new resource | `POST /users` |
| `PUT` | Update entire resource | `PUT /users/{id}` |
| `PATCH` | Partial update | `PATCH /users/{id}/activate` |
| `DELETE` | Delete resource | `DELETE /users/{id}` |

### Special Operations

| Method | Purpose | Example |
|--------|---------|---------|
| `PATCH` | State changes | `PATCH /users/{id}/activate` |
| `GET` | Related resources | `GET /users/{id}/vehicle` |

## Request Patterns

### Authentication
All protected endpoints require authentication via session cookie:

```http
Cookie: session=jwt_token_here
```

### Content Type
All requests with body must include:

```http
Content-Type: application/json
```

### Pagination
List endpoints support pagination:

```http
GET /users?page=1&limit=10&sortBy=createdAt&sortOrder=desc
```

### Filtering
Many endpoints support filtering:

```http
GET /users?isActive=true&role=admin
```

## Response Patterns

### Success Response Format

```json
{
  "success": true,
  "data": { ... },
  "message": "Operation successful"
}
```

### Error Response Format

```json
{
  "success": false,
  "error": {
    "message": "Error description",
    "code": "ERROR_CODE",
    "details": { ... }
  }
}
```

### Paginated Response

```json
{
  "success": true,
  "data": [
    { ... },
    { ... }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

## Validation Patterns

### Input Validation
All inputs are validated using Zod schemas:

```typescript
// Example validation schema
const CreateUserSchema = z.object({
  email: z.string().email(),
  fullname: z.string().min(1),
  phoneNumber: z.string().regex(/^\+?[1-9]\d{1,14}$/)
});
```

### UUID Validation
All ID parameters are validated as UUIDs:

```http
GET /users/550e8400-e29b-41d4-a716-446655440000
```

### Error Codes
Standard error codes are used:

- `VALIDATION_ERROR` - Input validation failed
- `NOT_FOUND` - Resource not found
- `UNAUTHORIZED` - Authentication required
- `FORBIDDEN` - Insufficient permissions
- `CONFLICT` - Resource already exists
- `INTERNAL_ERROR` - Server error

## Permission Patterns

### Permission Decorators
Controllers use permission decorators:

```typescript
@RequirePermission('user:read')
async getUsers() { ... }

@RequirePermission('user:write')
async createUser() { ... }

@RequirePermission('user:delete')
async deleteUser() { ... }
```

### Permission Hierarchy
Permissions follow a resource:action pattern:

- `{resource}:read` - Read operations
- `{resource}:write` - Create/Update operations
- `{resource}:delete` - Delete operations

## Rate Limiting Patterns

### Throttling Decorators
Endpoints can use throttling:

```typescript
@Throttle({ default: { limit: 10, ttl: 60000 } })
@SkipThrottle() // Skip rate limiting
```

### Rate Limit Headers
Responses include rate limit information:

```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640995200
```

## Data Patterns

### Timestamps
All entities include standard timestamps:

```json
{
  "id": "uuid",
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
```

### Soft Deletes
Resources use soft deletes with `isActive` flag:

```json
{
  "id": "uuid",
  "isActive": true,
  "deletedAt": null
}
```

### Relationships
Resources include related data:

```json
{
  "id": "uuid",
  "name": "Building A",
  "sector": {
    "id": "uuid",
    "name": "Sector 1"
  }
}
```

## Error Handling Patterns

### Validation Errors
```json
{
  "success": false,
  "error": {
    "message": "Validation failed",
    "code": "VALIDATION_ERROR",
    "details": {
      "email": ["Invalid email format"],
      "phoneNumber": ["Phone number is required"]
    }
  }
}
```

### Not Found Errors
```json
{
  "success": false,
  "error": {
    "message": "User not found",
    "code": "NOT_FOUND",
    "details": "User with ID 'uuid' does not exist"
  }
}
```

### Permission Errors
```json
{
  "success": false,
  "error": {
    "message": "Insufficient permissions",
    "code": "FORBIDDEN",
    "details": "Required permission: user:read"
  }
}
```

## Integration Patterns

### Client-Side Error Handling
```javascript
try {
  const response = await fetch('/api/v1/users', {
    credentials: 'include'
  });
  
  const data = await response.json();
  
  if (!data.success) {
    throw new Error(data.error.message);
  }
  
  return data.data;
} catch (error) {
  // Handle error
  console.error('API Error:', error.message);
}
```

### Retry Logic
```javascript
async function apiCall(url, options = {}, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url, {
        credentials: 'include',
        ...options
      });
      
      if (response.ok) {
        return await response.json();
      }
      
      if (response.status === 401) {
        // Redirect to login
        window.location.href = '/login';
        return;
      }
      
      throw new Error(`HTTP ${response.status}`);
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
}
```

## Best Practices

### Request Headers
Always include proper headers:

```javascript
const headers = {
  'Content-Type': 'application/json',
  'Accept': 'application/json'
};
```

### Error Handling
Implement comprehensive error handling:

```javascript
function handleApiError(error) {
  switch (error.code) {
    case 'UNAUTHORIZED':
      // Redirect to login
      break;
    case 'FORBIDDEN':
      // Show permission error
      break;
    case 'VALIDATION_ERROR':
      // Show validation errors
      break;
    default:
      // Show generic error
  }
}
```

### Caching
Implement appropriate caching:

```javascript
// Cache user data
const userCache = new Map();

async function getUser(id) {
  if (userCache.has(id)) {
    return userCache.get(id);
  }
  
  const user = await apiCall(`/users/${id}`);
  userCache.set(id, user);
  return user;
}
```

## Testing Patterns

### Unit Tests
```javascript
describe('UsersController', () => {
  it('should get users with pagination', async () => {
    const response = await request(app)
      .get('/api/v1/users')
      .query({ page: 1, limit: 10 })
      .expect(200);
    
    expect(response.body.success).toBe(true);
    expect(response.body.data).toBeInstanceOf(Array);
  });
});
```

### Integration Tests
```javascript
describe('User Management Flow', () => {
  it('should create, update, and delete user', async () => {
    // Create user
    const createResponse = await request(app)
      .post('/api/v1/users')
      .send(userData)
      .expect(201);
    
    const userId = createResponse.body.data.id;
    
    // Update user
    await request(app)
      .put(`/api/v1/users/${userId}`)
      .send(updatedData)
      .expect(200);
    
    // Delete user
    await request(app)
      .delete(`/api/v1/users/${userId}`)
      .expect(200);
  });
});
```
